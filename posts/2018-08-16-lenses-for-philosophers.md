---
title: Lenses for philosophers
date: 16/08/2018
---

Lens tutorials [are the new](https://www.reddit.com/r/haskell/comments/2cl28r/lenses_from_the_ground_up/) monad tutorials, I hear. (This is neat, since [monads](http://seanbowman.me/blog/monads-history-context/) and lenses were both discovered in the year 1958.) The thing is, after independently rediscovering lenses and working on them for a year and a half before [Jeremy Gibbons](http://www.cs.ox.ac.uk/jeremy.gibbons/) made the connection, I have a very different perspective on them. This post is based on a talk I gave at the [7th international workshop on bidirectional transformations](https://2018.programming-conference.org/track/bx-2018-papers) in Nice. My aim is to [move fast and break things](https://xkcd.com/1428/), where the things in question are your preconceptions about what lenses are and what they can be used for. Much of this will be a history of lenses, which includes at least 9 independent rediscoveries.

The earliest discovery of lenses (that I know of) was by [Kurt Gödel](https://en.wikipedia.org/wiki/Kurt_G%C3%B6del) in 1958, as part of his [dialectica interpretation](https://www.andrew.cmu.edu/user/avigad/Papers/dialect.pdf). (Actually it presented at a lecture at Yale in 1941, but not published until 1958. Gödel was quite the perfectionist.) The dialectica interpretation is a proof translation from [Heyting arithmetic](https://plato.stanford.edu/entries/logic-intuitionistic/#IntuNumbTheoHeytAritMath) (the intuitionistic first-order theory of arithmetic) into system T (a logic with no quantifiers, but with variables of higher-order types). Gödel's [original aim](https://pdfs.semanticscholar.org/31ab/8dbbf500a4308811b220cf0c61c1c02c51b6.pdf) was philosophical, part of an [extended Hilbert programme](https://plato.stanford.edu/entries/hilbert-program/#5) studying the relative consistency of different logical features. Combined with Spector's [bar recursion](https://www.eecs.qmul.ac.uk/~pbo/papers/paper011.pdf), it is used to extract constructive information from borderline-nonconstructive proofs in analysis (see [applied proof theory](https://link.springer.com/book/10.1007/978-3-540-77533-1)).

The dialectica interpretation translates a logical formula $\varphi$ to a double-indexed family of logical formulas $|\varphi|^{x : X}_{s : S}$, where $x$ and $s$ are free variables of types $X$ and $S$. This translation has the property that $\varphi$ is equivalent to $\exists x \forall s . |\varphi|^x_s$. This means that we can view $x$ as a possible proof and $s$ as a possible counter-proof. The formula is true iff there exists a proof that 'defeats' every possible counter-proof.

The definition of $|\varphi|^{x : X}_{s : S}$ from $\varphi$ is defined by structural recursion on formulas $\varphi$. For example, if we already know $|\varphi|^{x : X}_{s : S}$ and $|\psi|^{y : Y}_{r : R}$ then the interpretation of the conjunction $\varphi \wedge \psi$ is defined by

$$ |\varphi \wedge \psi|^{x : X, y : Y}_{s : S, r : R} = |\varphi|^x_s \wedge |\psi|^y_r $$

Formally this is really a product type $|\varphi \wedge \psi|^{(x, y) : X \times Y}_{(s, r) : S \times R}$, but it looks nicer to write tuples of variables instead.

The most interesting thing about the dialectica interpretation (and this is a universal opinion, not just me) is how it interprets (intuitionistic) implication. Suppose we already know $|\varphi|^{x : X}_{s : S}$ and $|\psi|^{y : Y}_{r : R}$. Then $\varphi \to \psi$ is interpreted as

$$ |\varphi \to \psi|^{v : X \to Y, u : X \times R \to S}_{x : X, r : R} = |\varphi|^x_{u (x, r)} \to |\psi|^{v (x)}_r $$

A proof of $\varphi \to \psi$ is a lens from proofs of $\varphi$ to proofs of $\psi$! Crucially, if we cut together a proof of $\varphi \to \psi$ and a proof of $\psi \to \chi$, the resulting proof of $\varphi \to \chi$ is obtained by ordinary lens composition. But is it reasonable to call them lenses, though?

What is a lens *actually*? A lens consists of two parts. The first part is an ordinary function $f : X \to Y$. We also have some sort of data floating [over](https://ncatlab.org/nlab/show/Grothendieck+fibration) $X$ and $Y$. These might be, for example, sets of [update actions](https://danel.ahman.ee/papers/bx17.pdf), or it could be possible amounts of profit, or it could be counter-proofs as in the dialectica interpretation. The last thing that defines a lens is a *backpropagation* rule, which takes a value $x$ and the data associated to $f (x)$, and gives the data associated to $x$. For example if you know $x$ and you are given an update action on $f (x)$, the lens tells you the corresponding update action on $x$. Similarly, if you know $x$ and you know the monetary value of $f (x)$, then the lens tells you the monetary value of $x$.

The dialectica interpretation was put in a modern form beginning in 1989 by [Valeria de Paiva](https://vcvpaiva.github.io/), replacing logic with categories. Much insight about the structure of lenses can be learned from de Paiva's papers, beginning with the fact that the category of lenses can be made a sound model of [linear logic](https://plato.stanford.edu/entries/logic-linear/). For example in [Morphisms of Open Games](https://arxiv.org/abs/1711.07059) I use the fact that certain coproducts of lenses exist in order to handle unbalanced [extensive-form](https://en.wikipedia.org/wiki/Extensive-form_game) game trees; I could have saved myself the trouble by reading page 13 of de Paiva's [1991 tech report](https://www.cl.cam.ac.uk/techreports/UCAM-CL-TR-213.pdf). Keep in mind though that the majority of her work is on a variant that looks like the category of isos.

Going back a bit to 1982, Frank Oles defines lenses in chapter 6 of his [PhD thesis](http://www.cs.cmu.edu/afs/cs.cmu.edu/project/fox-19/member/jcr/www/FrankOlesThesis.pdf), together with all 3 lens laws, and the interpretation that they are bidirectional transformations of datatypes. Oles calls view and update 'forgetting' and 'replacement'. I had never heard of this, until Bob Atkey pointed it out to me just after I published this blog post, when I added this paragraph at adjusted the numbers a bit. After a reverse citation search, through, I found that Johnson, Rosebrugh and Wood attribute leneses to Oles in [these](http://jucs.org/jucs_16_5/algebras_and_update_strategies/jucs_16_05_0729_0748_johnson.pdf) two [papers](https://www.mta.ca/~rrosebru/articles/lfut.pdf).

In 1995 lenses and the lens laws appear again, in Martin Hoffmann and Benjamin Pierce's paper [Positive Subtyping](https://www.lfcs.inf.ed.ac.uk/reports/94/ECS-LFCS-94-303/), with reference back to Oles. According to the paper, it was an independent discovery and the link, which they call a "coincidence", was made by John Reynolds and Bob Tennent.

The next stop is in 2005, when the 'modern era' of lenses began with the publication of [Combinators for Bi-directional Tree Transformations](http://www.cis.upenn.edu/~bcpierce/papers/lenses-toplas-final.pdf) by Foster, Greenwald, Moore, Pierce and Schmitt. They introduced the term 'lens', wrote down the 3 lens laws again, and classified lenses into 'well behaved' and 'very well behaved' according to those laws. This paper is a rare chance to correctly use the term [seminal](https://dictionary.cambridge.org/dictionary/english/seminal), in the sense that it spawned the entire field of bx ('bidirectional transformations'), but it didn't appear in a vacuum: from their references it is clear that database theorists had been working towards the idea for some time. They actually reference both Oles and Hoffman-Pierce, but not many people noticed, and FGMPS are usually credited with the discovery of lenses.

The lens laws are really the crux of everything I'm saying. From my earlier general and informal definition of lenses, it is possible to justify the (associative) composition law of lenses, but it is not possible to justify the lens laws. The laws are firmly properties of update actions — similar laws also appear in [Hoare logic](https://en.wikipedia.org/wiki/Hoare_logic) for example. For many other lens-like things the laws are either false, or more likely fail to even type-check. I considered calling the general thing, namely "things that look like lenses and compose like lenses", something like 'pre-lenses' or 'quasi-lenses'. But I have the opinion that if it walks like a duck and composes like a duck, then you ought to call it a duck.

The lens laws are undoubtedly important, and not just because they're true in the case of updates. Very well behaved lenses are equivalent[^1] to the much simpler constant-complement lenses, and are also equivalently [coalgebras of a comonad](https://r6research.livejournal.com/23705.html). Most of the theoretical work that uses the term 'lenses' takes the laws as given. Many bx researchers define 'lenses' to be what FGMPS called 'well behaved lenses', and consider that something not satisfying the lens laws is no lens at all.

[^1]: Editor's note: There was [a dead link](https://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.12.2428) here to a paper that I can't track down, with the (apparently nonexistent) DOI `10.1.1.12.2428`. This is how I learned that DOIs are a scam and they are not permanent at all.

Around the same time as the FGMPS paper in the mid-2000s, Haskell programmers started talking about *functional references*, based on getters and setters from object oriented programming. The motivation is that Haskell's encapsulation of effects, while important, is quite awkward when working with an inherently state-heavy application such as videogames. The origins of the idea are firmly folklore and probably lost in the depths of IRC, but Edward Kmett wrote a [history](https://github.com/ekmett/lens/wiki/History-of-Lenses), and the proper attribution is probably to Luke Palmer's blog post [here](http://web.archive.org/web/20080515203207/http://luqui.org/blog/archives/2007/07/26/making-haskell-nicer-for-game-programming/).

Although the connection was made fairly quickly (I don't know who made it) and functional references were renamed to lenses, bx theorists and functional programmers have remained fairly separate. While bx theorists focussed mainly on applications, functional programmers pushed down into the foundations: [van Laarhoven lenses](https://www.twanvl.nl/blog/haskell/cps-functional-references) and [profunctor lenses](https://arxiv.org/abs/1703.10857), despite being motivated by a quirk of how the GHC dialect of Haskell handles polymorphism, are very interesting and nontrivial things from a theoretical point of view. The mistake that the average lens tutorial makes is to present the van Laarhoven isomorphism as a central concept, rather than an implementation detail.

While bx researchers focussed on *monomorphic* lenses $X \to Y$ (where $X$ and $Y$ are sets or otherwise datatypes) which consist of a view function $X \to Y$ and an update function $X \times Y \to X$, functional programmers switched to *polymorphic lenses* after they were [introduced](https://r6.ca/blog/20120623T104901Z.html) by Russell O'Connor. These consist (after some serious de-obfuscation) of a view function $X \to Y$ and an update function $X \times R \to S$. But crucially, the parameters $X,Y,R,S$ are types in a *polymorphic* typesystem that can have type variables in common. Kmett then [pointed out](http://comonad.com/reader/2012/mirrored-lenses/) that this polymorphism can be used to talk about the lens laws. Sadly this was quite informal, and as far as I know the lens laws for 4-variant polymorphic lenses have remained handwaved ever sense.

It's time to jump forward in time again. It's 2015 and I [write down](/posts/2018-04-02-pre-history-open-games.html) the play/coplay functions of [open games](https://arxiv.org/abs/1603.04641), and their composition law. For a fixed strategy, an open game's play function takes an observation to an action; and its coplay function takes an observation and the payoffs resulting from an action, and gives the payoffs associated to the observation. The delicate interaction between play and coplay is a crucial component of how game theory is made compositional. Coplay is probably also the hardest thing to understand about open games, and for a long time I used phrases like 'weird/entangled information flow'. I know now that the term 'bidirectional' is precisely what I meant.

At this point I knew that play and coplay looked a bit like the dialectica interpretation/categories, but I didn't think the link was significant.

After I had been working on open games for about 1.5 years and written my [thesis](/posts/2018-01-16-towards-compositional-game-theory.html) about them, I moved to Oxford and took the chance to clean up the mathematical foundations. In particular I isolated the 'weird information flow' parts from the game-theoretic parts. Initially I called the category whose morphisms are play/coplay pairs $\mathbf{PC}$. Then I noticed that $\mathbf{PC}$ is fibred over the category of sets by extracting the play part. *Then* I noticed that this fibration is the fibrewise opposite of Bart Jacobs' *simple fibration*. (The reference on this is his book *Categorical logic and type theory*, which can be downloaded as an 800-page pdf [here](https://people.mpi-sws.org/~dreyer/courses/catlogic/jacobs.pdf), but be warned it is not for the faint of heart!) The simple fibration is used in (and named for) the categorical semantics of [simple type theory](https://plato.stanford.edu/entries/type-theory-church/), where it models the interaction between typing contexts and terms.

So I renamed $\mathbf{PC}$ 'the op-simple fibration'. I gave [a talk](https://www.cs.ox.ac.uk/seminars/1676.html) at Oxford's [OASIS seminar](https://www.cs.ox.ac.uk/seminars/oasis/), partly focussing on the op-simple fibration as a category that I thought was of independent interest. Jeremy Gibbons was in the audience, and he commented, essentially, "This looks like lenses." At this point I'd heard of lenses but I thought they were something from applied functional programming that wasn't relevant to me. (In particular, I associated them with Template Haskell.) I went to check and, sure enough, it was lenses. At first this was just a formal renaming, and it was another year and a half before I started to intuit the meaning of this connection, and even that was only by generalising the understanding of lenses as I explained earlier. Additionally at this point I found exercise 1.10.11 in Jacobs' book which explicitly links the op-simple fibration to dialectica categories, but I *still* didn't think they were close enough to be significant. (There's no way I can hide the fact that I'm stubbornly wrong more often that is good for me. Nearly everything I'm writing in this article is stuff I refused to believe at first, so don't attribute any of it to me.)

There's a catch to calling these things 'lenses' though: They are 4-variant (i.e. they consist of functions $X \to Y$ and $X \times R \to S$), but *not* polymorphic. This means that the lens laws don't even type check. The good news, though, is that since functional programmers handwave the lens laws anyway, nearly everything continues to apply: in particular, you can define van Laarhoven and profunctor lenses in the non-polymorphic setting. I call them 'bimorphic lenses', although I also like Cezar Ionescu's suggestion 'outlaw lenses'.

At this point I was contacted out of the blue by Mitchell Riley, a PhD student at Wesleyan. He had read [my paper](https://arxiv.org/abs/1704.02230) connecting lenses and open games, and showed me [this paper](https://arxiv.org/abs/0711.1859). Again, it took me embarrassingly long to accept this connection; admittedly the paper is written in the fine tradition of Australian category theory and is totally unreadable to me. The double construction turns out to be equivalent to a lawless version of constant complement lenses that at the time was even more folkloric than usual for the functional programming community. Since then it was used by Guillaume Boisseau and Jeremy Gibbons in [this paper](https://www.cs.ox.ac.uk/jeremy.gibbons/publications/proyo.pdf), and Mitchell's insight turned out to be crucial (and extremely well-timed) for my (still ongoing) work on Bayesian open games with Joe Bolt and Philipp Zahn.[^2]

[^2]: Editor's note: That work eventually became [this paper](https://compositionality.episciences.org/13528), and before that, Joe's PhD thesis.

The next thing that happened was in late 2017 when Brendan Fong, David Spivak and Rémy Tuyéras dropped the paper [Backprop as Functor](https://arxiv.org/abs/1711.10455) on the arXiv, which got a lot of people quite excited. It made it to the top of my reading list in early 2018, just before David came to Oxford for [an OASIS seminar](https://www.cs.ox.ac.uk/seminars/1973.html) of his own about the paper. As soon as I started reading it I saw immediately that they had independently reinvented a big chunk of the category of open games, and in particular their category of open learners is to monomorphic lenses (almost) exactly as open games is to bimorphic lenses. This paper was my personal tipping point where I had enough examples of lens-like things to see the common structure, and I was able to finally have intuition for coplay, perhaps my  key invention, by analogy to it.

Here is how David (implicitly) explained lenses in machine learning. Suppose we fix the parameters of a learning algorithm. Those parameters define a function, which is the forwards part of a lens. For example, suppose inputs are images and the outputs are booleans, where the intent is for the output to be true iff the image is of a cat. For some given parameters, the algorithm will (correctly or not) classify images into cats and non-cats. Now suppose we have a picture which is classified as a non-cat, but is in fact a cat. The *update* part (which FST call *request*) takes the original input and the *updated* output, and it *updates* the input by producing a [slightly modified](https://en.wikipedia.org/wiki/Gradient_descent) image that moves it towards being classified with the given output. This procedure is sometimes called dreaming, and it can produce [beautiful, disturbing, psychodelic images](https://www.iflscience.com/artificial-intelligence-dreams-28978). The only subtlety is that update corresponds to updating the *input* (as it should be for a lens), not to the more obvious step of updating the *parameters* (i.e. learning).

During the seminar history came full circle, and I played the role of Jeremy, commenting "This looks like lenses." The next day, me and David sat down and proved that open learners monoidally embed into open games. I later learned that [Mike Johnson](http://web.science.mq.edu.au/~mike/) had contacted them around the same time to tell them about the connection between open learners and lenses, and they responded by introducing him to open games. I spoke to Mike and [Bob Rosebrugh](https://mta.ca/~rrosebru/) at bx'2018, where I learned many interesting things, and I also learned that Bob claims to have independently rediscovered lenses too (while working in industry, if I remember correctly). I only mention this because it allowed me to claim 9 rather than 8 independent rediscoveries in my clickbaity first paragraph.

There is one more connection I know about in this wacky web of ideas. It turns out that David Spivak also independently rediscovered *bimorphic* lenses, and didn't connect it to the Backprop paper. This one was realised by Christina Vasilakopoulou after I spent most of the [Applied Category Theory](https://www.lorentzcenter.nl/applied-category-theory-1st-week-tutorial-at-snellius-2nd-week-workshop-at-oort.html) workshop in Leiden telling everybody who would listen about all these connections, rather like this:

![](/assets/posts/2018-08-16-lenses-for-philosophers/img1.jpg)

But I'm going to keep this last one a mystery, so we have some surprise left when we get around to writing a paper.[^3]

[^3]: Editor's note: That paper never happened, but if I remember correctly, during the workshop we realised that lenses are also the same thing as [wiring diagrams](https://arxiv.org/abs/1305.0297). Over the next several years the lens pattern continued to be so ubiquitous that it started to feel like a meme, and I eventually gave the name [categorical cybernetics](/posts/2022-05-29-what-is-categorical-cybernetics.html) to the field defined by the common structure.
